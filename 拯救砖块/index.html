<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>拯救砖块</title>
  <style>
    #canvas {
      border: 1px solid gray;
    }

  </style>
</head>
<body>
  <canvas id="canvas" width="1000" height="500"></canvas>

  <script>
    var imgFromPath = function (path) {
      let img = new Image()
      img.src = path
      return img
    }
    
    const Paddle = function () {
      let img = imgFromPath('../assets/paddle.png')
      let o = {
        img,
        x: 100,
        y: 400,
        speed: 5,
      }
      o.collide = function(ball) {
        // 需要判断是否相撞
        
      }
      o.moveLeft = function () {
        o.x -= o.speed
        o.x = o.x >= 0? o.x : 0
      }
      o.moveRight = function () {
        o.x += o.speed
        o.x = o.x <= canvas.width - 200? o.x : canvas.width - 200
      }
      return o
    }

    const Ball = function () {
      let img = imgFromPath('../assets/ball.png')
      let o = {
        img,
        x: 10,
        y: 20,
        speedX: 5,
        speedY: 5,
        fiered: false
      }
      o.fire = function () {
        o.fiered = true
      }
      o.move = function () {
        if (o.fiered) {
        console.log('ball move')
          if (o.x < 0 || o.x > 970) {
            o.speedX = -o.speedX
          }
          if (o.y < 0 || o.y > 470 ) {
            o.speedY = -o.speedY
          }
          o.x += o.speedX
          o.y += o.speedY
        }
      }
     
      return o
    }
    
    const Game = function () {
      let g = {
        actions: {},
        keydowns: {}
      }
      
      g.canvas = document.querySelector('#canvas')
      g.ctx = canvas.getContext('2d')

      g.register = function (key, cb) {
        g.actions[key] = cb
      }
      g.drawImg = function (image) {
        g.ctx.drawImage(image.img, image.x, image.y)
      }
      g.clear = function () {
        g.ctx.clearRect(0, 0, g.canvas.width, g.canvas.height)
      }

      // events
      document.addEventListener('keydown', event => {
        g.keydowns[event.key] = true
      })
      document.addEventListener('keyup', event => {
        g.keydowns[event.key] = false
      })
      
      setInterval(function(){
        // events
        let keys = Object.keys(g.actions)
        keys.forEach(k => {
          if (g.keydowns[k]) {
            g.actions[k]()
          }
        })
        // clear
        g.clear()
        // update
        g.update()
        // draw
        g.draw()
     }, 1000/30)

     return g
    } 


    function main () {
    
      var paddle = Paddle()
      var ball = Ball()
      var g = Game()
      
      g.update = function () {
        ball.move()
      }
      g.draw = function () {
        g.drawImg(paddle)
        g.drawImg(ball)
      }
      // 注册按键事件
      g.register ('a', function () {
        paddle.moveLeft()
      })
      g.register ('d', function () {
        paddle.moveRight()
      })
      g.register ('f', function () {
        ball.fire()
        // 判断相撞
        if (paddle.collide(ball)) {
          ball.speedY *= -1
        }
      })
    }

    main()



  </script>
  
</body>
</html>